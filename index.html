<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Art Banner Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --dark-lighter: #334155;
            --gray: #64748b;
            --gray-light: #cbd5e1;
            --gray-lighter: #f1f5f9;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --radius: 8px;
            --radius-lg: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: var(--dark);
            color: var(--white);
            overflow: hidden;
            height: 100vh;
        }

        /* Header */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--dark-light);
            border-bottom: 1px solid var(--dark-lighter);
            box-shadow: var(--shadow-lg);
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-left i {
            font-size: 24px;
            color: var(--primary);
        }

        .header-left h1 {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--dark-lighter);
            color: var(--white);
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .header-btn:hover {
            background: var(--gray);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .header-btn.primary {
            background: var(--primary);
        }

        .header-btn.primary:hover {
            background: var(--primary-dark);
        }

        .header-btn i {
            font-size: 16px;
        }

        /* Workspace */
        .workspace {
            display: flex;
            height: calc(100vh - 65px);
            gap: 1px;
            background: var(--dark-lighter);
        }

        /* Sidebars */
        .sidebar {
            width: 320px;
            background: var(--dark-light);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .sidebar-section {
            background: var(--dark-light);
            padding: 20px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--dark-lighter);
        }

        .section-header i {
            color: var(--primary);
            font-size: 18px;
        }

        .section-header h3 {
            font-size: 16px;
            font-weight: 600;
            flex: 1;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .icon-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        /* Upload Grid */
        .upload-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .upload-card {
            position: relative;
        }

        .file-input {
            display: none;
        }

        .upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px;
            background: var(--dark-lighter);
            border: 2px dashed var(--gray);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .upload-label:hover {
            border-color: var(--primary);
            background: var(--dark);
        }

        .upload-label i {
            font-size: 24px;
            color: var(--primary);
        }

        .upload-label span {
            font-size: 14px;
            font-weight: 500;
        }

        .upload-label small {
            font-size: 12px;
            color: var(--gray);
        }

        /* Properties */
        .property-group {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--dark-lighter);
            border-radius: var(--radius);
        }

        .property-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--dark);
            font-weight: 600;
            font-size: 14px;
        }

        .property-header i {
            color: var(--primary-light);
        }

        .property-item {
            margin-bottom: 16px;
        }

        .property-item:last-child {
            margin-bottom: 0;
        }

        .property-item label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--gray-light);
        }

        .property-item label i {
            font-size: 12px;
            color: var(--primary-light);
        }

        .value-display {
            margin-left: auto;
            color: var(--primary);
            font-weight: 600;
        }

        .text-input,
        .position-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--dark);
            color: var(--white);
            border: 1px solid var(--dark);
            border-radius: var(--radius);
            font-size: 14px;
            transition: var(--transition);
        }

        .text-input:focus,
        .position-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        input[type="color"] {
            width: 100%;
            height: 44px;
            padding: 4px;
            background: var(--dark);
            border: 1px solid var(--dark);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        input[type="color"]:hover {
            border-color: var(--primary);
        }

        .slider {
            width: 100%;
            height: 6px;
            background: var(--dark);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }

        .slider::-webkit-slider-thumb:hover {
            background: var(--primary-light);
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .position-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        /* Canvas Area */
        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--dark-light);
        }

        .canvas-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--dark-light);
            border-bottom: 1px solid var(--dark-lighter);
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tool-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--dark-lighter);
            color: var(--white);
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .tool-btn:hover {
            background: var(--gray);
            transform: translateY(-1px);
        }

        .tool-btn.active {
            background: var(--primary);
        }

        .zoom-control {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 12px;
            background: var(--dark-lighter);
            border-radius: var(--radius);
        }

        .zoom-control i {
            color: var(--gray-light);
        }

        .zoom-control .slider {
            width: 120px;
        }

        .zoom-control span {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            min-width: 45px;
        }

        .canvas-wrapper {
            flex: 1;
            overflow: auto;
            background: 
                linear-gradient(45deg, #1e293b 25%, transparent 25%),
                linear-gradient(-45deg, #1e293b 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #1e293b 75%),
                linear-gradient(-45deg, transparent 75%, #1e293b 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #mainCanvas {
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            box-shadow: var(--shadow-xl);
            transition: transform 0.1s ease;
            cursor: grab;
        }

        #mainCanvas:active {
            cursor: grabbing;
        }

        .selection-box {
            position: absolute;
            border: 2px solid var(--primary);
            background: rgba(99, 102, 241, 0.1);
            pointer-events: none;
            display: none;
        }

        .canvas-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--dark-light);
            border-top: 1px solid var(--dark-lighter);
        }

        .footer-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--gray-light);
        }

        .footer-info i {
            color: var(--primary-light);
        }

        .footer-info span {
            font-weight: 500;
        }

        /* Layers */
        .layers-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .layer-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--dark-lighter);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .layer-item:hover {
            background: var(--dark);
            border-color: var(--gray);
        }

        .layer-item.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .layer-visibility {
            cursor: pointer;
            font-size: 16px;
            color: var(--gray-light);
            transition: var(--transition);
        }

        .layer-visibility:hover {
            color: var(--primary);
        }

        .layer-visibility.hidden {
            color: var(--danger);
        }

        .layer-info {
            flex: 1;
            min-width: 0;
        }

        .layer-name {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .layer-type {
            font-size: 12px;
            color: var(--gray);
            margin-top: 2px;
        }

        .layer-controls {
            display: flex;
            gap: 4px;
        }

        .layer-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--dark);
            color: var(--white);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 12px;
        }

        .layer-btn:hover {
            background: var(--primary);
        }

        .layer-btn.delete:hover {
            background: var(--danger);
        }

        /* Presets */
        .presets-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .preset-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .preset-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .presets-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .preset-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--dark-lighter);
            border-radius: var(--radius);
            transition: var(--transition);
            cursor: pointer;
        }

        .preset-item:hover {
            background: var(--dark);
        }

        .preset-item span {
            font-size: 13px;
            font-weight: 500;
        }

        .preset-item small {
            font-size: 11px;
            color: var(--gray);
            display: block;
            margin-top: 4px;
        }

        .preset-delete {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--dark);
            color: var(--danger);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .preset-delete:hover {
            background: var(--danger);
            color: var(--white);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-lighter);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .sidebar {
                width: 280px;
            }
        }

        @media (max-width: 1200px) {
            .workspace {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Top Header -->
        <header class="app-header">
            <div class="header-left">
                <i class="fas fa-palette"></i>
                <h1>Banner Studio</h1>
            </div>
            <div class="header-actions">
                <button id="saveProject" class="header-btn" title="Save Project">
                    <i class="fas fa-save"></i>
                    <span>Save</span>
                </button>
                <button id="loadProject" class="header-btn" title="Load Project">
                    <i class="fas fa-folder-open"></i>
                    <span>Load</span>
                </button>
                <button id="exportBtn" class="header-btn primary" title="Export PNG">
                    <i class="fas fa-download"></i>
                    <span>Export</span>
                </button>
            </div>
        </header>

        <div class="workspace">
            <!-- Left Sidebar -->
            <aside class="sidebar left-sidebar">
                <div class="sidebar-section">
                    <div class="section-header">
                        <i class="fas fa-upload"></i>
                        <h3>Assets</h3>
                    </div>
                    <div class="upload-grid">
                        <div class="upload-card">
                            <input type="file" id="baseImage" accept="image/png" class="file-input">
                            <label for="baseImage" class="upload-label">
                                <i class="fas fa-image"></i>
                                <span>Base Image</span>
                                <small id="baseFileName">No file selected</small>
                            </label>
                        </div>
                        <div class="upload-card">
                            <input type="file" id="bannerImage" accept="image/png" class="file-input">
                            <label for="bannerImage" class="upload-label">
                                <i class="fas fa-ribbon"></i>
                                <span>Banner</span>
                                <small id="bannerFileName">No file selected</small>
                            </label>
                        </div>
                        <div class="upload-card">
                            <input type="file" id="lettersFolder" accept="image/png" multiple class="file-input">
                            <label for="lettersFolder" class="upload-label">
                                <i class="fas fa-font"></i>
                                <span>Letters</span>
                                <small id="lettersFileName">No files selected</small>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="section-header">
                        <i class="fas fa-sliders-h"></i>
                        <h3>Properties</h3>
                    </div>
                    
                    <div class="property-group" id="bannerProperties">
                        <div class="property-header">
                            <i class="fas fa-ribbon"></i>
                            <span>Banner</span>
                        </div>
                        <div class="property-item">
                            <label>
                                <i class="fas fa-palette"></i>
                                Color
                            </label>
                            <input type="color" id="bannerColor" value="#0066ff">
                        </div>
                        <div class="position-grid">
                            <div class="property-item">
                                <label><i class="fas fa-arrows-alt-h"></i> X</label>
                                <input type="number" id="bannerX" value="0" class="position-input">
                            </div>
                            <div class="property-item">
                                <label><i class="fas fa-arrows-alt-v"></i> Y</label>
                                <input type="number" id="bannerY" value="0" class="position-input">
                            </div>
                            <div class="property-item">
                                <label><i class="fas fa-layer-group"></i> Z</label>
                                <input type="number" id="bannerZ" value="2" min="0" class="position-input">
                            </div>
                        </div>
                    </div>

                    <div class="property-group" id="textProperties">
                        <div class="property-header">
                            <i class="fas fa-font"></i>
                            <span>Text</span>
                        </div>
                        <div class="property-item">
                            <label>
                                <i class="fas fa-keyboard"></i>
                                Content
                            </label>
                            <input type="text" id="bannerText" placeholder="Enter text..." maxlength="30" class="text-input">
                        </div>
                        <div class="property-item">
                            <label>
                                <i class="fas fa-palette"></i>
                                Color
                            </label>
                            <input type="color" id="textColor" value="#ffffff">
                        </div>
                        <div class="property-item">
                            <label>
                                <i class="fas fa-text-width"></i>
                                Spacing <span class="value-display" id="spacingValue">0</span>
                            </label>
                            <input type="range" id="letterSpacing" min="-10" max="50" value="0" class="slider">
                        </div>
                        <div class="position-grid">
                            <div class="property-item">
                                <label><i class="fas fa-arrows-alt-h"></i> X</label>
                                <input type="number" id="textX" value="0" class="position-input">
                            </div>
                            <div class="property-item">
                                <label><i class="fas fa-arrows-alt-v"></i> Y</label>
                                <input type="number" id="textY" value="0" class="position-input">
                            </div>
                            <div class="property-item">
                                <label><i class="fas fa-layer-group"></i> Z</label>
                                <input type="number" id="textZ" value="3" min="0" class="position-input">
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Canvas Area -->
            <main class="canvas-area">
                <div class="canvas-toolbar">
                    <div class="toolbar-group">
                        <button id="resetZoom" class="tool-btn" title="Reset Zoom">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <div class="zoom-control">
                            <i class="fas fa-search"></i>
                            <input type="range" id="zoomSlider" min="25" max="500" value="100" class="slider">
                            <span id="zoomValue">100%</span>
                        </div>
                        <button id="centerCanvas" class="tool-btn" title="Center Canvas">
                            <i class="fas fa-compress-arrows-alt"></i>
                        </button>
                    </div>
                    <div class="toolbar-group">
                        <button id="toggleGrid" class="tool-btn" title="Toggle Grid">
                            <i class="fas fa-th"></i>
                        </button>
                        <button id="toggleSnap" class="tool-btn" title="Snap to Grid">
                            <i class="fas fa-magnet"></i>
                        </button>
                    </div>
                </div>
                
                <div class="canvas-wrapper" id="canvasWrapper">
                    <canvas id="mainCanvas"></canvas>
                    <div class="selection-box" id="selectionBox"></div>
                </div>
                
                <div class="canvas-footer">
                    <div class="footer-info">
                        <i class="fas fa-ruler-combined"></i>
                        <span id="canvasSize">0 Ã— 0</span>
                    </div>
                    <div class="footer-info">
                        <i class="fas fa-mouse-pointer"></i>
                        <span id="mousePos">0, 0</span>
                    </div>
                    <div class="footer-info">
                        <i class="fas fa-search"></i>
                        <span id="zoomDisplay">100%</span>
                    </div>
                </div>
            </main>

            <!-- Right Sidebar -->
            <aside class="sidebar right-sidebar">
                <div class="sidebar-section">
                    <div class="section-header">
                        <i class="fas fa-layer-group"></i>
                        <h3>Layers</h3>
                        <button id="addLayer" class="icon-btn" title="Add Layer">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="layersList" class="layers-container"></div>
                </div>

                <div class="sidebar-section">
                    <div class="section-header">
                        <i class="fas fa-history"></i>
                        <h3>Presets</h3>
                    </div>
                    <div class="presets-container">
                        <button id="savePreset" class="preset-btn">
                            <i class="fas fa-bookmark"></i>
                            <span>Save Preset</span>
                        </button>
                        <div id="presetsList" class="presets-list"></div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <input type="file" id="customLayer" accept="image/png" style="display:none;">
    <input type="file" id="loadProjectInput" accept=".json" style="display:none;">

    <script>
        // Application State
        const state = {
            canvas: null,
            ctx: null,
            layers: [],
            baseImage: null,
            bannerImage: null,
            letters: {},
            zoom: 1,
            canvasWidth: 800,
            canvasHeight: 600,
            selectedLayer: null,
            isDragging: false,
            dragStart: { x: 0, y: 0 },
            gridEnabled: false,
            snapEnabled: false,
            presets: []
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initCanvas();
            initEventListeners();
            addDefaultLayers();
            loadPresets();
            render();
        });

        // Initialize Canvas
        function initCanvas() {
            state.canvas = document.getElementById('mainCanvas');
            state.ctx = state.canvas.getContext('2d', { willReadFrequently: true });
            state.ctx.imageSmoothingEnabled = false;
            setCanvasSize(800, 600);
        }

        // Set Canvas Size
        function setCanvasSize(width, height) {
            state.canvasWidth = width;
            state.canvasHeight = height;
            state.canvas.width = width;
            state.canvas.height = height;
            updateCanvasInfo();
        }

        // Initialize Event Listeners
        function initEventListeners() {
            // File uploads
            document.getElementById('baseImage').addEventListener('change', handleBaseImage);
            document.getElementById('bannerImage').addEventListener('change', handleBannerImage);
            document.getElementById('lettersFolder').addEventListener('change', handleLetters);
            document.getElementById('customLayer').addEventListener('change', handleCustomLayer);
            
            // Banner properties
            document.getElementById('bannerColor').addEventListener('input', updateBannerColor);
            document.getElementById('bannerX').addEventListener('input', updateBannerPosition);
            document.getElementById('bannerY').addEventListener('input', updateBannerPosition);
            document.getElementById('bannerZ').addEventListener('input', updateBannerZ);
            
            // Text properties
            document.getElementById('bannerText').addEventListener('input', updateText);
            document.getElementById('textColor').addEventListener('input', updateTextColor);
            document.getElementById('letterSpacing').addEventListener('input', updateLetterSpacing);
            document.getElementById('textX').addEventListener('input', updateTextPosition);
            document.getElementById('textY').addEventListener('input', updateTextPosition);
            document.getElementById('textZ').addEventListener('input', updateTextZ);
            
            // Canvas controls
            document.getElementById('zoomSlider').addEventListener('input', handleZoom);
            document.getElementById('resetZoom').addEventListener('click', resetZoom);
            document.getElementById('centerCanvas').addEventListener('click', centerCanvas);
            document.getElementById('toggleGrid').addEventListener('click', toggleGrid);
            document.getElementById('toggleSnap').addEventListener('click', toggleSnap);
            
            // Project controls
            document.getElementById('saveProject').addEventListener('click', saveProject);
            document.getElementById('loadProject').addEventListener('click', () => {
                document.getElementById('loadProjectInput').click();
            });
            document.getElementById('loadProjectInput').addEventListener('change', loadProject);
            document.getElementById('exportBtn').addEventListener('click', exportCanvas);
            
            // Layer controls
            document.getElementById('addLayer').addEventListener('click', () => {
                document.getElementById('customLayer').click();
            });
            
            // Preset controls
            document.getElementById('savePreset').addEventListener('click', savePreset);
            
            // Canvas interactions
            state.canvas.addEventListener('mousedown', handleCanvasMouseDown);
            state.canvas.addEventListener('mousemove', handleCanvasMouseMove);
            state.canvas.addEventListener('mouseup', handleCanvasMouseUp);
            state.canvas.addEventListener('mouseleave', handleCanvasMouseUp);
            document.getElementById('canvasWrapper').addEventListener('mousemove', updateMousePos);
            state.canvas.addEventListener('wheel', handleWheel, { passive: false });
        }

        // Add Default Layers
        function addDefaultLayers() {
            state.layers = [
                { id: 1, name: 'Base', type: 'base', visible: true, data: null, x: 0, y: 0, z: 1 },
                { id: 2, name: 'Banner', type: 'banner', visible: true, data: null, x: 0, y: 0, z: 2, color: null },
                { id: 3, name: 'Text', type: 'text', visible: true, data: null, x: 0, y: 0, z: 3, text: '', color: '#ffffff', spacing: 0 }
            ];
            updateLayersList();
        }

        // File Handlers
        async function handleBaseImage(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('baseFileName').textContent = file.name;
            const img = await loadImage(file);
            state.baseImage = img;
            setCanvasSize(img.width, img.height);
            
            const layer = state.layers.find(l => l.type === 'base');
            if (layer) layer.data = img;
            
            render();
        }

        async function handleBannerImage(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('bannerFileName').textContent = file.name;
            const img = await loadImage(file);
            state.bannerImage = img;
            
            const layer = state.layers.find(l => l.type === 'banner');
            if (layer) layer.data = img;
            
            render();
        }

        async function handleLetters(e) {
            const files = Array.from(e.target.files);
            document.getElementById('lettersFileName').textContent = `${files.length} files`;
            
            state.letters = {};
            for (const file of files) {
                const img = await loadImage(file);
                const letterName = file.name.replace(/\.(png|jpg|jpeg)$/i, '').toLowerCase();
                state.letters[letterName] = img;
            }
            
            render();
        }

        async function handleCustomLayer(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const img = await loadImage(file);
            const maxZ = Math.max(...state.layers.map(l => l.z), 0);
            
            const newLayer = {
                id: Date.now(),
                name: file.name.replace(/\.(png|jpg|jpeg)$/i, ''),
                type: 'custom',
                visible: true,
                data: img,
                x: 0,
                y: 0,
                z: maxZ + 1
            };
            
            state.layers.push(newLayer);
            updateLayersList();
            render();
        }

        // Property Updates
        function updateBannerColor(e) {
            const layer = state.layers.find(l => l.type === 'banner');
            if (layer) {
                layer.color = e.target.value;
                render();
            }
        }

        function updateBannerPosition() {
            const layer = state.layers.find(l => l.type === 'banner');
            if (layer) {
                layer.x = parseInt(document.getElementById('bannerX').value) || 0;
                layer.y = parseInt(document.getElementById('bannerY').value) || 0;
                render();
            }
        }

        function updateBannerZ() {
            const layer = state.layers.find(l => l.type === 'banner');
            if (layer) {
                layer.z = parseInt(document.getElementById('bannerZ').value) || 0;
                sortLayers();
                updateLayersList();
                render();
            }
        }

        function updateText(e) {
            const layer = state.layers.find(l => l.type === 'text');
            if (layer) {
                layer.text = e.target.value.toUpperCase();
                render();
            }
        }

        function updateTextColor(e) {
            const layer = state.layers.find(l => l.type === 'text');
            if (layer) {
                layer.color = e.target.value;
                render();
            }
        }

        function updateLetterSpacing(e) {
            const spacing = parseInt(e.target.value);
            document.getElementById('spacingValue').textContent = spacing;
            
            const layer = state.layers.find(l => l.type === 'text');
            if (layer) {
                layer.spacing = spacing;
                render();
            }
        }

        function updateTextPosition() {
            const layer = state.layers.find(l => l.type === 'text');
            if (layer) {
                layer.x = parseInt(document.getElementById('textX').value) || 0;
                layer.y = parseInt(document.getElementById('textY').value) || 0;
                render();
            }
        }

        function updateTextZ() {
            const layer = state.layers.find(l => l.type === 'text');
            if (layer) {
                layer.z = parseInt(document.getElementById('textZ').value) || 0;
                sortLayers();
                updateLayersList();
                render();
            }
        }

        // Canvas Controls
        function handleZoom(e) {
            const zoom = parseInt(e.target.value);
            document.getElementById('zoomValue').textContent = zoom + '%';
            document.getElementById('zoomDisplay').textContent = zoom + '%';
            state.zoom = zoom / 100;
            updateCanvasTransform();
        }

        function resetZoom() {
            state.zoom = 1;
            document.getElementById('zoomSlider').value = 100;
            document.getElementById('zoomValue').textContent = '100%';
            document.getElementById('zoomDisplay').textContent = '100%';
            updateCanvasTransform();
        }

        function centerCanvas() {
            const wrapper = document.getElementById('canvasWrapper');
            wrapper.scrollLeft = (wrapper.scrollWidth - wrapper.clientWidth) / 2;
            wrapper.scrollTop = (wrapper.scrollHeight - wrapper.clientHeight) / 2;
        }

        function toggleGrid() {
            state.gridEnabled = !state.gridEnabled;
            document.getElementById('toggleGrid').classList.toggle('active');
            render();
        }

        function toggleSnap() {
            state.snapEnabled = !state.snapEnabled;
            document.getElementById('toggleSnap').classList.toggle('active');
        }

        function updateCanvasTransform() {
            state.canvas.style.transform = `scale(${state.zoom})`;
        }

        function updateMousePos(e) {
            const rect = state.canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / state.zoom);
            const y = Math.floor((e.clientY - rect.top) / state.zoom);
            document.getElementById('mousePos').textContent = `${x}, ${y}`;
        }

        function handleWheel(e) {
            if (e.ctrlKey) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -10 : 10;
                const newZoom = Math.max(25, Math.min(500, parseInt(document.getElementById('zoomSlider').value) + delta));
                document.getElementById('zoomSlider').value = newZoom;
                handleZoom({ target: { value: newZoom } });
            }
        }

        // Canvas Interaction
        function handleCanvasMouseDown(e) {
            const rect = state.canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / state.zoom);
            const y = Math.floor((e.clientY - rect.top) / state.zoom);
            
            state.isDragging = true;
            state.dragStart = { x, y };
            
            // Find clicked layer
            const sortedLayers = [...state.layers].sort((a, b) => b.z - a.z);
            for (const layer of sortedLayers) {
                if (layer.visible && isPointInLayer(x, y, layer)) {
                    state.selectedLayer = layer;
                    break;
                }
            }
        }

        function handleCanvasMouseMove(e) {
            if (!state.isDragging || !state.selectedLayer) return;
            
            const rect = state.canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / state.zoom);
            const y = Math.floor((e.clientY - rect.top) / state.zoom);
            
            let deltaX = x - state.dragStart.x;
            let deltaY = y - state.dragStart.y;
            
            if (state.snapEnabled) {
                deltaX = Math.round(deltaX / 10) * 10;
                deltaY = Math.round(deltaY / 10) * 10;
            }
            
            state.selectedLayer.x += deltaX;
            state.selectedLayer.y += deltaY;
            
            state.dragStart = { x, y };
            
            // Update property inputs
            if (state.selectedLayer.type === 'banner') {
                document.getElementById('bannerX').value = state.selectedLayer.x;
                document.getElementById('bannerY').value = state.selectedLayer.y;
            } else if (state.selectedLayer.type === 'text') {
                document.getElementById('textX').value = state.selectedLayer.x;
                document.getElementById('textY').value = state.selectedLayer.y;
            }
            
            render();
        }

        function handleCanvasMouseUp() {
            state.isDragging = false;
            state.selectedLayer = null;
        }

        function isPointInLayer(x, y, layer) {
            if (!layer.data && layer.type !== 'text') return false;
            
            if (layer.type === 'text') {
                const text = layer.text || '';
                const spacing = layer.spacing || 0;
                let width = 0;
                let height = 0;
                
                for (const char of text) {
                    const letterImg = state.letters[char.toLowerCase()];
                    if (letterImg) {
                        width += letterImg.width + spacing;
                        height = Math.max(height, letterImg.height);
                    }
                }
                
                return x >= layer.x && x <= layer.x + width &&
                       y >= layer.y && y <= layer.y + height;
            }
            
            return x >= layer.x && x <= layer.x + layer.data.width &&
                   y >= layer.y && y <= layer.y + layer.data.height;
        }

        // Layer Management
        function sortLayers() {
            state.layers.sort((a, b) => a.z - b.z);
        }

        function updateLayersList() {
            const list = document.getElementById('layersList');
            list.innerHTML = '';
            
            const sorted = [...state.layers].sort((a, b) => b.z - a.z);
            
            sorted.forEach(layer => {
                const item = document.createElement('div');
                item.className = 'layer-item';
                item.dataset.layerId = layer.id;
                
                const visIcon = layer.visible ? 'fa-eye' : 'fa-eye-slash';
                const visClass = layer.visible ? '' : 'hidden';
                
                item.innerHTML = `
                    <i class="fas ${visIcon} layer-visibility ${visClass}" onclick="toggleLayerVisibility(${layer.id})"></i>
                    <div class="layer-info">
                        <div class="layer-name">${layer.name}</div>
                        <div class="layer-type">Z: ${layer.z} | ${layer.type}</div>
                    </div>
                    <div class="layer-controls">
                        <button class="layer-btn" onclick="moveLayerUp(${layer.id})" title="Move Up">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="layer-btn" onclick="moveLayerDown(${layer.id})" title="Move Down">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        ${layer.type === 'custom' ? `
                            <button class="layer-btn delete" onclick="deleteLayer(${layer.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                `;
                
                list.appendChild(item);
            });
        }

        window.toggleLayerVisibility = function(id) {
            const layer = state.layers.find(l => l.id === id);
            if (layer) {
                layer.visible = !layer.visible;
                updateLayersList();
                render();
            }
        };

        window.moveLayerUp = function(id) {
            const layer = state.layers.find(l => l.id === id);
            if (layer) {
                layer.z++;
                sortLayers();
                updateLayersList();
                render();
            }
        };

        window.moveLayerDown = function(id) {
            const layer = state.layers.find(l => l.id === id);
            if (layer && layer.z > 0) {
                layer.z--;
                sortLayers();
                updateLayersList();
                render();
            }
        };

        window.deleteLayer = function(id) {
            state.layers = state.layers.filter(l => l.id !== id);
            updateLayersList();
            render();
        };

        // Render
        function render() {
            state.ctx.clearRect(0, 0, state.canvasWidth, state.canvasHeight);
            
            if (state.gridEnabled) {
                renderGrid();
            }
            
            const sorted = [...state.layers].sort((a, b) => a.z - b.z);
            
            sorted.forEach(layer => {
                if (!layer.visible) return;
                
                switch (layer.type) {
                    case 'base':
                        if (layer.data) {
                            state.ctx.drawImage(layer.data, layer.x, layer.y);
                        }
                        break;
                    case 'banner':
                        if (layer.data) {
                            if (layer.color) {
                                const colored = applyColorWithShading(layer.data, layer.color);
                                state.ctx.drawImage(colored, layer.x, layer.y);
                            } else {
                                state.ctx.drawImage(layer.data, layer.x, layer.y);
                            }
                        }
                        break;
                    case 'text':
                        renderText(layer);
                        break;
                    case 'custom':
                        if (layer.data) {
                            state.ctx.drawImage(layer.data, layer.x, layer.y);
                        }
                        break;
                }
            });
        }

        function renderGrid() {
            state.ctx.strokeStyle = 'rgba(99, 102, 241, 0.2)';
            state.ctx.lineWidth = 1;
            
            for (let x = 0; x < state.canvasWidth; x += 10) {
                state.ctx.beginPath();
                state.ctx.moveTo(x, 0);
                state.ctx.lineTo(x, state.canvasHeight);
                state.ctx.stroke();
            }
            
            for (let y = 0; y < state.canvasHeight; y += 10) {
                state.ctx.beginPath();
                state.ctx.moveTo(0, y);
                state.ctx.lineTo(state.canvasWidth, y);
                state.ctx.stroke();
            }
        }

        function renderText(layer) {
            const text = layer.text || '';
            const spacing = layer.spacing || 0;
            const color = layer.color || '#ffffff';
            
            if (!text || Object.keys(state.letters).length === 0) return;
            
            let currentX = layer.x;
            const y = layer.y;
            
            for (const char of text) {
                const letterKey = char.toLowerCase();
                const letterImg = state.letters[letterKey];
                
                if (letterImg) {
                    const colored = applyColorWithShading(letterImg, color);
                    state.ctx.drawImage(colored, currentX, y);
                    currentX += letterImg.width + spacing;
                } else if (char === ' ') {
                    currentX += 10 + spacing;
                }
            }
        }

        function applyColorWithShading(img, hexColor) {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            ctx.imageSmoothingEnabled = false;
            
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            const targetColor = hexToRgb(hexColor);
            
            for (let i = 0; i < data.length; i += 4) {
                const alpha = data[i + 3];
                if (alpha === 0) continue;
                
                const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3 / 255;
                
                data[i] = targetColor.r * brightness;
                data[i + 1] = targetColor.g * brightness;
                data[i + 2] = targetColor.b * brightness;
            }
            
            ctx.putImageData(imageData, 0, 0);
            return canvas;
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 255, g: 255, b: 255 };
        }

        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Project Management
        function saveProject() {
            const project = {
                canvasWidth: state.canvasWidth,
                canvasHeight: state.canvasHeight,
                layers: state.layers.map(l => ({
                    id: l.id,
                    name: l.name,
                    type: l.type,
                    visible: l.visible,
                    x: l.x,
                    y: l.y,
                    z: l.z,
                    color: l.color,
                    text: l.text,
                    spacing: l.spacing
                })),
                bannerColor: document.getElementById('bannerColor').value,
                textColor: document.getElementById('textColor').value,
                letterSpacing: parseInt(document.getElementById('letterSpacing').value),
                bannerText: document.getElementById('bannerText').value
            };
            
            const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `banner-project-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadProject(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const project = JSON.parse(event.target.result);
                    
                    // Restore canvas size
                    setCanvasSize(project.canvasWidth, project.canvasHeight);
                    
                    // Restore layer properties
                    project.layers.forEach(saved => {
                        const layer = state.layers.find(l => l.id === saved.id);
                        if (layer) {
                            Object.assign(layer, saved);
                        }
                    });
                    
                    // Restore UI
                    document.getElementById('bannerColor').value = project.bannerColor;
                    document.getElementById('textColor').value = project.textColor;
                    document.getElementById('letterSpacing').value = project.letterSpacing;
                    document.getElementById('bannerText').value = project.bannerText;
                    document.getElementById('bannerX').value = project.layers.find(l => l.type === 'banner')?.x || 0;
                    document.getElementById('bannerY').value = project.layers.find(l => l.type === 'banner')?.y || 0;
                    document.getElementById('bannerZ').value = project.layers.find(l => l.type === 'banner')?.z || 2;
                    document.getElementById('textX').value = project.layers.find(l => l.type === 'text')?.x || 0;
                    document.getElementById('textY').value = project.layers.find(l => l.type === 'text')?.y || 0;
                    document.getElementById('textZ').value = project.layers.find(l => l.type === 'text')?.z || 3;
                    
                    updateLayersList();
                    render();
                } catch (error) {
                    alert('Error loading project: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Presets
        function savePreset() {
            const name = prompt('Enter preset name:');
            if (!name) return;
            
            const preset = {
                id: Date.now(),
                name,
                date: new Date().toISOString(),
                bannerX: parseInt(document.getElementById('bannerX').value),
                bannerY: parseInt(document.getElementById('bannerY').value),
                bannerZ: parseInt(document.getElementById('bannerZ').value),
                textX: parseInt(document.getElementById('textX').value),
                textY: parseInt(document.getElementById('textY').value),
                textZ: parseInt(document.getElementById('textZ').value),
                letterSpacing: parseInt(document.getElementById('letterSpacing').value),
                bannerColor: document.getElementById('bannerColor').value,
                textColor: document.getElementById('textColor').value
            };
            
            state.presets.push(preset);
            localStorage.setItem('bannerPresets', JSON.stringify(state.presets));
            updatePresetsList();
        }

        function loadPresets() {
            const saved = localStorage.getItem('bannerPresets');
            if (saved) {
                state.presets = JSON.parse(saved);
                updatePresetsList();
            }
        }

        function updatePresetsList() {
            const list = document.getElementById('presetsList');
            list.innerHTML = '';
            
            state.presets.forEach(preset => {
                const item = document.createElement('div');
                item.className = 'preset-item';
                item.onclick = () => applyPreset(preset.id);
                
                const date = new Date(preset.date).toLocaleDateString();
                
                item.innerHTML = `
                    <div>
                        <span>${preset.name}</span>
                        <small>${date}</small>
                    </div>
                    <button class="preset-delete" onclick="event.stopPropagation(); deletePreset(${preset.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                list.appendChild(item);
            });
        }

        function applyPreset(id) {
            const preset = state.presets.find(p => p.id === id);
            if (!preset) return;
            
            document.getElementById('bannerX').value = preset.bannerX;
            document.getElementById('bannerY').value = preset.bannerY;
            document.getElementById('bannerZ').value = preset.bannerZ;
            document.getElementById('textX').value = preset.textX;
            document.getElementById('textY').value = preset.textY;
            document.getElementById('textZ').value = preset.textZ;
            document.getElementById('letterSpacing').value = preset.letterSpacing;
            document.getElementById('bannerColor').value = preset.bannerColor;
            document.getElementById('textColor').value = preset.textColor;
            
            updateBannerPosition();
            updateBannerZ();
            updateTextPosition();
            updateTextZ();
            updateLetterSpacing({ target: { value: preset.letterSpacing } });
            updateBannerColor({ target: { value: preset.bannerColor } });
            updateTextColor({ target: { value: preset.textColor } });
        }

        window.deletePreset = function(id) {
            state.presets = state.presets.filter(p => p.id !== id);
            localStorage.setItem('bannerPresets', JSON.stringify(state.presets));
            updatePresetsList();
        };

        // Export
        function exportCanvas() {
            const link = document.createElement('a');
            link.download = `banner-${Date.now()}.png`;
            link.href = state.canvas.toDataURL('image/png');
            link.click();
        }

        // Update Canvas Info
        function updateCanvasInfo() {
            document.getElementById('canvasSize').textContent = `${state.canvasWidth} Ã— ${state.canvasHeight}`;
        }
    </script>
</body>
</html>
